<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Voice Conversion Demo</title>
<style>
  :root{
    --page-w: 1100px;
    --gap: 20px;
    --card-bg: rgba(255,255,255,.85);
    --border: rgba(200,200,200,.8);
    --main-color: #50aead;
  }

  html,body{
    height:100%;
    margin:0;
    font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;
    background: transparent;
    color:var(--main-color);
    overflow-y:auto;
  }

  /* ===== Background (soft colorful glow) ===== */
  .gradient{
    position:fixed; inset:0; z-index:0;
    background:#ffffff;
  }
  .gradient::after{
    content:""; position:absolute; inset:-20%;
    filter:blur(140px) saturate(120%);
    background:conic-gradient(from 0deg,
      rgba(59,130,246,.25),
      rgba(168,85,247,.25),
      rgba(16,185,129,.25),
      rgba(245,158,11,.25),
      rgba(59,130,246,.25));
    animation:spin 20s linear infinite;
  }
  @keyframes spin{ to{ transform:rotate(360deg) } }
  #bg-canvas{
    position:fixed; inset:0; z-index:1; pointer-events:none;
  }

  /* ===== Foreground ===== */
  .page{ max-width:var(--page-w); margin:32px auto; padding:0 16px; position:relative; z-index:2; }
  .title{ text-align:center; margin:0 0 24px; text-shadow:0 6px 22px rgba(0,0,0,.1); }

  /* --- logo --- */
  .logo-wrap{ text-align:center; margin-bottom:16px; }
  .logo{ max-width:140px; height:auto; display:inline-block; }

  .main-title {
    text-align:center;
    font-size:36px;
    font-weight:bold;
    margin-bottom:30px;
    color:var(--main-color);
    text-shadow:0 4px 12px rgba(0,0,0,.15);
  }

  .module{
    background:var(--card-bg);
    border:1px solid var(--border);
    border-radius:16px;
    padding:18px; margin-bottom:28px;
    box-shadow:0 10px 25px rgba(0,0,0,.08);
    backdrop-filter:saturate(140%) blur(8px);
    color:var(--main-color);
  }
  .module h2{ text-align:center; margin:6px 0 16px; }
  .grid{ display:grid; grid-template-columns:repeat(3,1fr); gap:var(--gap); }
  .col{
    background:#fff; border:1px solid var(--border);
    border-radius:12px; padding:14px; box-shadow:0 6px 16px rgba(0,0,0,.05);
    color:var(--main-color);
  }
  .col h3{ margin:0 0 10px; font-size:16px; }
  select{ width:100%; padding:8px 10px; border:1px solid var(--border); border-radius:10px; background:#fff; margin-bottom:10px; font-size:14px; color:#333; }
  audio{ width:100%; }

  @media (max-width:900px){
    .grid{ grid-template-columns:1fr; }
    .page{ margin:16px auto; }
    .logo{ max-width:120px; }
  }
</style>
</head>
<body>
  <!-- Background -->
  <div class="gradient" aria-hidden="true"></div>
  <canvas id="bg-canvas" aria-hidden="true"></canvas>

  <!-- Foreground -->
  <div class="page">
    <div class="logo-wrap">
      <!-- 若需要换另一张，改成 TAB_col_background.png 或你的路径 -->
      <img src="TAB_col_white_background.png" alt="School Logo" class="logo">
    </div>

    <h1 class="main-title">
      Disentangled Speech Representation Learning with Binary Contrastive Loss: Improving Speaker Consistency in Voice Conversion
    </h1>

    <h2 class="title">Voice Conversion Comparison Demo</h2>

    <!-- Module 1 -->
    <section class="module" id="speechtripnet">
      <h2>SpeechTripNet</h2>
      <div class="grid">
        <div class="col">
          <h3>Source Speaker</h3>
          <select id="stnSourceSelect"></select>
          <audio id="stnSourceAudio" controls></audio>
        </div>
        <div class="col">
          <h3>Target Speaker</h3>
          <select id="stnTargetSelect"></select>
          <audio id="stnTargetAudio" controls></audio>
        </div>
        <div class="col">
          <h3>Converted Speech</h3>
          <audio id="stnConvertedAudio" controls></audio>
        </div>
      </div>
    </section>

    <!-- Module 2 -->
    <section class="module" id="baseline">
      <h2>Contrastive Model Results</h2>
      <div class="grid">
        <div class="col">
          <h3>Source Speaker</h3>
          <select id="baseSourceSelect"></select>
          <audio id="baseSourceAudio" controls></audio>
        </div>
        <div class="col">
          <h3>Target Speaker</h3>
          <select id="baseTargetSelect"></select>
          <audio id="baseTargetAudio" controls></audio>
        </div>
        <div class="col">
          <h3>Converted Speech</h3>
          <audio id="baseConvertedAudio" controls></audio>
        </div>
      </div>
    </section>
  </div>

<script>
/* ===== Particle background (fixed) ===== */
(function(){
  const c = document.getElementById('bg-canvas');
  const ctx = c.getContext('2d');
  let W,H,DPR, pts=[];
  const N=70, SPD=0.35, LINK=140;

  function resize(){
    DPR = Math.min(devicePixelRatio||1,2);
    W = c.width  = Math.floor(innerWidth * DPR);
    H = c.height = Math.floor(innerHeight * DPR);
    c.style.width  = innerWidth + 'px';
    c.style.height = innerHeight + 'px';
  }
  function rnd(a,b){return a + Math.random()*(b-a)}
  function init(){
    const palette = ["59,130,246","168,85,247","16,185,129"];
    pts = Array.from({length:N},()=>({
      x:rnd(0,W), y:rnd(0,H),
      vx:rnd(-SPD,SPD), vy:rnd(-SPD,SPD),
      r:rnd(1.5,2.5)*DPR, a:rnd(.25,.55),
      color: palette[Math.floor(Math.random()*palette.length)]
    }));
  }
  function step(){
    ctx.clearRect(0,0,W,H);
    for(let i=0;i<pts.length;i++){
      for(let j=i+1;j<pts.length;j++){
        const a=pts[i], b=pts[j];
        const dx=a.x-b.x, dy=a.y-b.y;   // ← 修复这里
        const d=Math.hypot(dx,dy);
        if(d<LINK*DPR){
          const alpha = 1 - d/(LINK*DPR);
          ctx.strokeStyle = `rgba(120,120,120,${0.15*alpha})`;
          ctx.lineWidth = 1;
          ctx.beginPath(); ctx.moveTo(a.x,a.y); ctx.lineTo(b.x,b.y); ctx.stroke();
        }
      }
    }
    for(const p of pts){
      ctx.fillStyle = `rgba(${p.color},${p.a})`;
      ctx.beginPath(); ctx.arc(p.x,p.y,p.r,0,Math.PI*2); ctx.fill();
      p.x += p.vx; p.y += p.vy;
      if(p.x<0||p.x>W) p.vx *= -1;
      if(p.y<0||p.y>H) p.vy *= -1;
    }
    requestAnimationFrame(step);
  }
  resize(); init(); step();
  addEventListener('resize', resize);
})();

/* ===== Load audio from GitHub + auto-map Converted ===== */
(async function(){
  const GH = {
    owner: 'orangecat1219',
    repo:  'Contractive-Speechtripnet',
    branch:'main',
    sourcePath: 'Data/source_speaker',
    targetPath: 'Data/target_speaker',
    convertedPath: 'Data/converted_speech/1-0.7'
  };

  const CONTENTS_API = (path) =>
    `https://api.github.com/repos/${GH.owner}/${GH.repo}/contents/${encodeURIComponent(path)}`;
  const RAW_URL = (path) =>
    `https://raw.githubusercontent.com/${GH.owner}/${GH.repo}/${GH.branch}/${path.split('/').map(encodeURIComponent).join('/')}`;

  const AUDIO_EXT = ['.wav','.mp3','.m4a','.flac','.ogg','.webm'];
  const ext = (name)=> name.slice(name.lastIndexOf('.')).toLowerCase();
  const noExt = (name)=> name.replace(/\.[^.]+$/,'');
  const isAudio = (name)=> AUDIO_EXT.includes(ext(name));
  const extractId = (filename)=> noExt(filename).replace(/^spk_/i,''); // 去扩展名 & 可选 spk_

  async function listAudio(path){
    const res = await fetch(CONTENTS_API(path), { headers: { 'Accept':'application/vnd.github+json' }});
    if(!res.ok) return [];
    const items = await res.json();
    return items
      .filter(x => x.type === 'file' && isAudio(x.name))
      .map(x => ({ label: x.name, url: x.download_url, name: x.name }));
  }

  function fillSelectWithFiles(selectEl, files, placeholder='— Select —'){
    const empty = `<option value="" data-id="">${placeholder}</option>`;
    const opts  = files.map(f => `<option value="${f.url}" data-id="${extractId(f.name)}">${f.label}</option>`).join('');
    selectEl.innerHTML = empty + opts;
    selectEl.value = "";
  }

  function setConvertedAudio(cAud, bareName){
    if(!bareName){ cAud.src=''; cAud.load(); return; }
    const wav = RAW_URL(`${GH.convertedPath}/${bareName}.wav`);
    const mp3 = RAW_URL(`${GH.convertedPath}/${bareName}.mp3`);
    cAud.onerror = null;
    cAud.src = wav; cAud.load();
    let triedWav = true;
    cAud.onerror = () => {
      if(triedWav){
        triedWav = false;
        cAud.onerror = null;
        cAud.src = mp3; cAud.load();
      }
    };
  }

  async function setupModule(prefix){
    const sSel = document.getElementById(`${prefix}SourceSelect`);
    const tSel = document.getElementById(`${prefix}TargetSelect`);
    const sAud = document.getElementById(`${prefix}SourceAudio`);
    const tAud = document.getElementById(`${prefix}TargetAudio`);
    const cAud = document.getElementById(`${prefix}ConvertedAudio`);

    const [srcFiles, tgtFiles] = await Promise.all([
      listAudio(GH.sourcePath),
      listAudio(GH.targetPath)
    ]);

    fillSelectWithFiles(sSel, srcFiles);
    fillSelectWithFiles(tSel, tgtFiles);

    sAud.src=''; sAud.load();
    tAud.src=''; tAud.load();
    cAud.src=''; cAud.load();

    function updateConvertedIfReady(){
      const sId = sSel.selectedOptions[0]?.dataset.id || '';
      const tId = tSel.selectedOptions[0]?.dataset.id || '';
      if(!sId || !tId){ setConvertedAudio(cAud,''); return; }
      setConvertedAudio(cAud, `spk_${sId}__TO__spk_${tId}`);
    }

    sSel.addEventListener('change', ()=>{ sAud.src = sSel.value || ''; sAud.load(); updateConvertedIfReady(); });
    tSel.addEventListener('change', ()=>{ tAud.src = tSel.value || ''; tAud.load(); updateConvertedIfReady(); });
  }

  await setupModule('stn');
  await setupModule('base');
})();
</script>
</body>
</html>